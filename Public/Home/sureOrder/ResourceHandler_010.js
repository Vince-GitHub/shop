var allTotal=0;var strConsigneeId=0;$(document).ready(function(){checkConsigneeCur();consigneeAddrHender();if(strIsAlipay=="1"){strIsAlipay="0"}else{InitAddress()}$("#consnee_save_submit").hide()});function checkConsignee(a){strConsigneeId=a;$("#formOrderConfirm_ConsigneeId").val(a);$("#formOrderConfirm_fpConsigneeId").val(a);$("#fpConsigneeId").val(a);$("#isTownId").val($("#town_"+a).val());TStrs="<dd>"+$("dd[addrid="+a+"]").html()+"</dd>";$("#updateAddress").html(TStrs);$("#updateAddress").find("span").remove();if(!(a==undefined||a==""||a=="0")){if($("#consignee_load").find("dd").length<=4){$(".consignee_Hender a.newAddr_btn").show();$(".olOrder_newConsignee p.consignee_Hender span").hide();$("#consignee_load").show();$(".consignee_Hender").show();$(".consignee_Hender a.allAddr_btn").hide();$(".consignee_Hender a.putAway_btn").addClass("putAway_btn non");$(".consingnee_list").css("height","155px")}else{if($("#consignee_load").find("dd").length<10){$(".consignee_Hender a.newAddr_btn").show();$(".olOrder_newConsignee p.consignee_Hender span").hide();$("#consignee_load").show();$(".consignee_Hender").show();$(".consignee_Hender a.allAddr_btn").show();if($("#consignee_load").height()>155){$(".allAddr_btn").hide();$(".putAway_btn").removeClass("non")}else{$(".allAddr_btn").show();$(".putAway_btn").addClass("non")}}else{$(".consignee_Hender a.newAddr_btn").show();$(".olOrder_newConsignee p.consignee_Hender span").show();$(".consignee_Hender .newAddr_btn").hide()}}$(".consignee_Addr").hide();$("#error_message").css("visibility","visible").text("")}}function loadConsigneeAddr(){$.ajax({url:"/trade/consigneelist",type:"POST",dataType:"html",success:function(a){if(a.indexOf("dd")<0){$("#consignee_load").removeClass("olOrder_conList consingnee_list");$(".consignee_Hender").hide();$(".consignee_Addr").show();$("#consnee_save_submit").hide();if($("#consnee_addr").val()==""){InitAddress()}}else{if(!$("#consignee_load").hasClass("olOrder_conList consingnee_list")){$("#consignee_load").addClass("olOrder_conList consingnee_list")}$("#consignee_load").html(a);if(strConsigneeId==0){checkConsigneeCur()}else{$("#consignee_load").find("dd").each(function(b,c){if(strConsigneeId==$(c).attr("addrid")){$(c).addClass("cur")}})}checkConsignee($("#consignee_load").children().first().attr("addrid"));consigneeAddrHender()}}})}function consigneeAddrHender(){$(".consingnee_list dd").delegate("label","click",function(){var e=$(this);$(".consingnee_list dd").removeClass("cur");e.parent().addClass("cur");e.siblings("input").prop("checked",true);var f=parseInt(e.parent("dd").attr("receivetime"));$(".olOrder_express").find("dd:eq(0) label").each(function(){var g=parseInt($(this).index()+1);if(f===g){$(this).find("input").attr("checked","checked");$(this).addClass("curr").siblings().removeClass("curr")}})});$(".consingnee_list input").change(function(){$(".consingnee_list dd").removeClass("cur");$(this).parent().addClass("cur")});var b=false;$(".consingnee_list dd").hover(function(){b=$(this).find("em").is(":visible");$(this).find("em").hide();$(this).addClass("hover").find("span").show()},function(){$(this).removeClass("hover").find("span").hide();if(b===true){$(this).find("em").show()}});var a=$(".consingnee_list dd").length;if(a==0){$(".consignee_Hender a.newAddr_btn").hide();$(".olOrder_newConsignee p.consignee_Hender span").show();$("#consignee_load").hide();$(".consignee_Hender").hide();$(".new_Addr").show();$("#consnee_save_submit").hide();$(".olOrder_newConsignee .new_Addr").show();newAddressClick()}else{if(a<=4){$(".consignee_Hender a.newAddr_btn").show();$(".olOrder_newConsignee p.consignee_Hender span").hide();$("#consignee_load").show();$(".consignee_Hender").show();$(".consignee_Hender a.allAddr_btn").hide();$(".consingnee_list").css("height","155px");newAddressClick()}else{if(a<10){$(".consignee_Hender a.newAddr_btn").show();$(".olOrder_newConsignee p.consignee_Hender span").hide();$("#consignee_load").show();$(".consignee_Hender").show();$(".consignee_Hender a.allAddr_btn").show();if($("#consignee_load").height()>155){$(".allAddr_btn").hide();$(".putAway_btn").removeClass("non")}else{$(".allAddr_btn").show();$(".putAway_btn").addClass("non")}newAddressClick()}else{if(a>=10){$(".consignee_Hender a.newAddr_btn").show();$(".olOrder_newConsignee p.consignee_Hender span").show();$(".consignee_Hender .newAddr_btn").hide()}}}}$(".olOrder_newConsignee").find(".allAddr_btn").click(function(){$(".consingnee_list").css("height","auto");$(this).next(".putAway_btn").removeClass("non");return false});$(".putAway_btn").click(function(){$(".allAddr_btn").show();$(this).addClass("non");$(".consingnee_list").css("height","155px");return false});$(".olOrder_newConsignee").find(".allAddr_btn").click(function(){$(".consingnee_list").find("dd").show();$(this).hide();if(a==10){$(this).siblings("span").show()}return false});$(".consingnee_list dd:first em").css("display","inline");$(".consingnee_list").delegate("a.change_addr","click",function(){var e=$(this).attr("addrid");$(".consignee_Addr .myinfo_Notice span").text("修改收货地址");$(this).parent("span").siblings("input").attr("checked","checked");$(".consignee_Hender").hide();$(".consignee_Addr").show();$(".addr_form .form_succeed, .addr_form dd p").hide();$(".addr_form dd").removeClass("error");return false});$("body, a").bind("click",function(){c()});function c(){var e=$(".removeCommodity");if(e.length){e.remove()}}$("body").delegate(".removeCommodity","click",function(){return false});$(".consingnee_list").delegate("a.set_del","click",function(f){f.stopPropagation();c();var e=$(this).closest("dd");removeAddr(e);$(".consignee_Hender").show();$(".consignee_Addr").hide();if($(".consignee_Addr").is(":visible")){$(".consignee_Addr").hide()}});$(".consignee_Addr .cancel_Btn").click(function(){if($(".consingnee_list").find("dd").length==0){$(".consingnee_list").css("height","0");$(".consignee_Hender a.newAddr_btn").hide();$(".olOrder_newConsignee p.consignee_Hender span").show();$("#consignee_load").hide();$(".consignee_Hender").hide();$(".new_Addr").show();$("#consnee_save_submit").hide();$(".olOrder_newConsignee .new_Addr").show();newAddressClick()}else{$(".consignee_Hender").show();$(".consignee_Addr").hide()}RemoveInsAddr()});$(".invoice_Addr_new .cancel_Btn").click(function(){$(".invoice_Addr_new").hide();$("#same_Addr").attr("checked","checked");$("#formOrderConfirm_fpConsigneeId").val($("#formOrderConfirm_ConsigneeId").val())});$("#deliveryAddress").hover(function(f){var g=parseInt($(this).offset().left)-20;var h=parseInt($(this).offset().top)+25;$(this).parents("dd").find("#defaultAddress").css({left:g,top:h});$(this).parents("dd").find("#defaultAddress").html($("#updateAddress").html());$(this).parents("dd").find("#defaultAddress").show()},function(){$(this).parents("dd").find("#defaultAddress").hide()});$("#other_name").hover(function(f){var g=parseInt($(this).offset().left)-20;var h=parseInt($(this).offset().top)+25;$(this).parents("dd").find("#otherAddress").css({left:g,top:h});$(this).parents("dd").find("#otherAddress").html(strOtherAddress);$(this).parents("dd").find("#otherAddress").show()},function(){$(this).parents("dd").find("#otherAddress").hide()});$("#active").delegate("#couponsTip","mouseover",function(g){var f=$(this);var h=f.attr("id");var i=parseInt(f.offset().left);var j=parseInt(f.offset().top)+35;d(f,h,i,j,"arrowLeft")});$("#active").delegate("#couponsTip","mouseout",function(f){$("#tips_"+$(this).attr("id")).remove()});$("#couponCode_active").delegate("#couponsCodeTip","mouseover",function(g){var f=$(this);var h=f.attr("id");var i=parseInt(f.offset().left);var j=parseInt(f.offset().top)+35;d(f,h,i,j,"arrowLeft")});$("#couponCode_active").delegate("#couponsCodeTip","mouseout",function(f){$("#tips_"+$(this).attr("id")).remove()});$(".couponsList").delegate(".explain","mouseover",function(){$this=$(this);var e=$this.attr("class")+$this.parents("table").find("tr").index($this.parent()[0]);var f=parseInt($this.offset().left)+30;var g=parseInt($this.offset().top)+35;d($this,e,f,g,"arrow")});$(".couponsList").delegate(".explain","mouseout",function(){var e=$this.attr("class")+$this.parents("table").find("tr").index($this.parent()[0]);$("#tips_"+e).remove()});function d(e,g,h,j,f){var i=e.attr("tips");var k='<div class="prompt_information" id=tips_'+g+' style="left:'+h+"px;top:"+j+'px"><span class="'+f+'"></span><div class="content">'+i+"</div></div>";$("body").append(k)}}function checkConsigneeCur(){$("#consignee_load").children(":first").addClass("cur");var a=$("#consignee_load").find("dd").eq(0).attr("addrid");$("#isTownId").val($("#town_"+a).val());TStrs="<dd>"+$("dd[addrid="+a+"]").html()+"</dd>";$("#updateAddress").html(TStrs);$("#updateAddress").find("span").remove();$("#formOrderConfirm_ConsigneeId").val(a);$("#formOrderConfirm_fpConsigneeId").val(a);$("#fpConsigneeId").val(a)}function newAddressClick(){$(".consignee_Hender a.newAddr_btn").click(function(){$(".consignee_Addr .myinfo_Notice span").text("新增收货地址");$(".consignee_Hender").hide();$(".consignee_Addr").show();$("#consnee_submit").show();$("#consnee_save_submit").hide();$(".addr_form .form_succeed, .addr_form dd p").hide();$(".addr_form dd").removeClass("error");RemoveInsAddr();return false})}function InitAddress(){fillProvince(0);fillCity(0);fillArea(0);fillTown(0)}function RemoveInsAddr(){$("#consnee_name").val("");fillProvince(0);fillCity(0);fillArea(0);fillTown(0);$("#consnee_addr").val("");$("#consnee_code").val("");$("#consnee_mobile").val("");$("#consnee_phone1").val("");$("#consnee_phone2").val("");$("#consnee_phone3").val("");$("#consnee_topaddr").html("")}function insAddr(){var lastFlag=0;if($("[name='consnee_flag']").attr("checked")){lastFlag=2}else{lastFlag=0}var str="ConsigneeName="+$("#consnee_name").val();str+="&ConsigneeProvinceId="+$("#ProvinceId").val();str+="&ConsigneeCityId="+$("#CityId").val();str+="&ConsigneeAreaId="+$("#AreaId").val();str+="&ConsigneeTownId="+$("#TownId").val();str+="&ConsigneeAddress="+$("#consnee_addr").val();str+="&ConsigneePostCode="+$("#consnee_code").val();str+="&ConsigneeMobile="+$("#consnee_mobile").val();str+="&ConsigneePhone="+$("#consnee_phone1").val()+"-"+$("#consnee_phone2").val()+"-"+$("#consnee_phone3").val();str+="&LastFlag="+lastFlag;$.ajax({url:"/trade/insertConsignAddrBySort",type:"POST",data:str,error:function(){alert("添加失败")},success:function(msg){var result=eval(msg);if(result.Success=="1"){strConsigneeId=0;strIsAlipay="0";loadConsigneeAddr();$(".olOrder_newConsignee p").show();$(".consignee_Addr").hide();$(".invoice_Addr p").hide();$(".addr_form .form_succeed, .addr_form dd p").hide();$(".addr_form dd").removeClass("error");$("#formOrderConfirm_fpConsigneeId").val(result.Message);$("#fpConsigneeId").val(result.Message)}else{alert(result.Message)}}})}function getAddr(consigneeId){if(consigneeId==undefined||consigneeId==""||consigneeId==null){return}else{var str="ConsigneeId="+consigneeId+"&r="+Math.random();$.ajax({url:"/trade/GetAddr",type:"POST",data:str,error:function(){},success:function(msg){var result=eval(msg);if(result.Success=="1"){$("#consnee_name").val(result.ConsigneeName);fillProvince(result.ConsigneeProvinceId);fillCity(result.ConsigneeCityId);fillArea(result.ConsigneeAreaId);fillTown(result.ConsigneeTownId);GetTopAddress();$("#consnee_addr").val(result.ConsigneeAddress);$("#consnee_code").val(result.ConsigneePostCode);$("#consnee_mobile").val(result.ConsigneeMobile);var consigneePhone=result.ConsigneePhone;if(consigneePhone=="--"){$("#consnee_phone").val("")}else{var phones=consigneePhone.split("-");if(phones.length==3){$("#consnee_phone1").val(phones[0]);$("#consnee_phone2").val(phones[1]);$("#consnee_phone3").val(phones[2])}if(phones.length==2){$("#consnee_phone1").val(phones[0]);$("#consnee_phone2").val(phones[1]);$("#consnee_phone3").val("")}$("#consnee_phone").val(consigneePhone)}if(result.LastFlag==2||result.LastFlag==3){$("#consnee_flag").attr("checked","checked")}else{$("#consnee_flag").attr("checked",false)}LoadAddr(consigneeId)}else{alert(result.Message)}}})}}function LoadAddr(a){$(".consignee_Addr .myinfo_Notice span").text("修改收货地址");$(".olOrder_newConsignee p.consignee_Hender").hide();$(".consignee_Addr").show();$("#consnee_submit").hide();$("#consnee_save_submit").show();return false}function updAddr(){var lastFlag=0;if($("[name='consnee_flag']").attr("checked")){lastFlag=2}else{lastFlag=0}var str="ConsigneeId="+$("#formOrderConfirm_ConsigneeId").val();str+="&ConsigneeName="+$("#consnee_name").val();str+="&ConsigneeProvinceId="+$("#ProvinceId").val();str+="&ConsigneeCityId="+$("#CityId").val();str+="&ConsigneeAreaId="+$("#AreaId").val();str+="&ConsigneeTownId="+$("#TownId").val();str+="&ConsigneeAddress="+$("#consnee_addr").val();str+="&ConsigneePostCode="+$("#consnee_code").val();str+="&ConsigneeMobile="+$("#consnee_mobile").val();str+="&ConsigneePhone="+$("#consnee_phone1").val()+"-"+$("#consnee_phone2").val()+"-"+$("#consnee_phone3").val();str+="&ConsigneeEmail=";str+="&memo=";str+="&LastFlag="+lastFlag;$.ajax({url:"/trade/updateConsigneeAddrBySort",type:"POST",data:str,success:function(msg){var result=eval(msg);if(result.Success=="1"){loadConsigneeAddr();strIsAlipay="0";$(".olOrder_newConsignee p").show();$(".consignee_Addr").hide();$(".invoice_Addr p").hide();$("#formOrderConfirm_fpConsigneeId").val($("#formOrderConfirm_ConsigneeId").val());$("#fpConsigneeId").val($("#formOrderConfirm_ConsigneeId").val())}}})}function removeAddr(ele,which){var attrProid=ele.attr("addrid");if(which){attrProid="more_"+new Date().getTime()}var thisLeft=parseInt(ele.offset().left)+60;var thisTop=parseInt(ele.offset().top)+30;var removeComm='<div id="spWindow_delete_proid'+attrProid+'" class="removeCommodity" style="left:'+thisLeft+"px; top:"+thisTop+'px"><span class="arrow"></span><div class="window_content"><div class="delete_txtinfo">确认要删除该地址吗？</div></div><div class="window_bottom"><a href="javascript:;" class="spOrder_submit">确 认</a><a href="javascript:;" class="spOrder_delbtn">取 消</a></div></div>';$("body").append(removeComm);$("body").delegate("#spWindow_delete_proid"+attrProid+" .spOrder_submit","click",function(event){event.stopPropagation();var $cart_list=ele.closest(".cart_list"),$cart_activity_wp=ele.closest(".cart_activity_wp");ele.fadeOut("fast",function(){if(ele.parent("dl").find("dd").length==1){$(".consignee_Hender").hide();$(".consignee_Addr").show();$(".consingnee_list").css("height","auto")}var str="ConsigneeId="+attrProid;$.ajax({url:"/trade/DelInvoiceAddr",type:"POST",data:str,async:false,error:function(){alert("删除失败")},success:function(msg){var result=eval(msg);if(result.Success=="1"){ele.remove();if($("#consignee_load").find("dd").length==0){$(".consignee_Hender a.newAddr_btn").hide();$(".olOrder_newConsignee p.consignee_Hender span").show();$("#consignee_load").hide();$(".consignee_Hender").hide();$(".new_Addr").show();$("#consnee_save_submit").hide();$("#consnee_submit").show();$(".olOrder_newConsignee .new_Addr").show();$(".consignee_Addr .myinfo_Notice span").text("新增收货地址");newAddressClick();$(".cancel_Btn").click();$("#formOrderConfirm_ConsigneeId").val("");$("#formOrderConfirm_fpConsigneeId").val("")}else{if($("#consignee_load").find("dd").length<=4){$(".consignee_Hender a.newAddr_btn").show();$(".olOrder_newConsignee p.consignee_Hender span").hide();$("#consignee_load").show();$(".consignee_Hender").show();$(".consignee_Hender a.allAddr_btn").hide();$(".consignee_Hender a.putAway_btn").addClass("putAway_btn non");$(".consingnee_list").css("height","155px");newAddressClick()}else{if($("#consignee_load").find("dd").length<10){$(".olOrder_newConsignee p.consignee_Hender span").hide();$(".newAddr_btn").show();newAddressClick()}}}$("#spWindow_delete_proid"+attrProid).remove();strConsigneeId=0;checkConsigneeCur()}else{alert(result.Message)}}});ele.remove();$("#spWindow_delete_proid"+attrProid).remove();return false})});$("body").delegate("#spWindow_delete_proid"+attrProid+" .spOrder_delbtn","click",function(event){event.stopPropagation();$(this).parents("#spWindow_delete_proid"+attrProid).remove()})}function loadCartList(){$.ajax({url:"/data/cart_list.txt",type:"GET",async:true,cache:false,dataType:"json",timeout:1000,success:function(a){if(a.length==0){$(".alCart_proList dl.proNone").fadeIn("fast");$(".hasprod, .noprod").hide()}else{$(a).each(function(b){var e=a[b].prodId,j=a[b].prodNo,o=a[b].prodUrl,f=a[b].prodImg,c=a[b].prodBrand,h=a[b].prodName,d=a[b].prodColor,m=a[b].prodSize,l=a[b].prodPrice,k=a[b].prodNum,n=a[b].stock;if(n!=0){var g;g+='<ul olboxid="'+e+'" class="clr">';g+='<li class="td_item">';g+='<div class="td_item_img">';g+='<a href="#">';g+='<img width="90" height="120" alt="" src="'+f+'" bigimg="'+f+'" style="opacity: 1;">';g+="</a>";g+="</div>";g+='<div class="td_item_title clr">';g+="<p>";g+='<a href="#">'+c+"</a>";g+="</p>";g+="<p>";g+='<a href="#">'+h+"</a>";g+="</p>";g+='<p class="padt5">';g+='<span class="color"><em>颜色：</em>'+d+"</span>";g+="<span><em>尺码：</em>"+m+"</span>";g+="</p>";g+="</div>";g+="</li>";g+='<li class="td_price">';g+="￥"+l;g+="</li>";g+='<li class="td_amount">';g+=k;g+="</li>";g+='<li class="td_sum">';g+='<i class="price_sign">￥</i>';g+='<span class="price_val">'+(l*k)+"</span>";g+="</li>";g+="</ul>";$(g).appendTo($("#alCart_proList_content"));$(g).appendTo($("#alCart_alProList_content"));if(n<k){$(".alCart_proList dl:eq("+b+") .numberBox").append("<p>该商品仅剩<i>"+n+"</i>件了，<i>您可以：<br />继续提交订单，结算仅剩商品 或 <a href='#'>返回购物袋</a>修改</i></p>")}allTotal+=parseInt(l*k)}else{var g;g+='<ul olboxid="'+e+'" class="clr fail">';g+='<li class="td_item">';g+='<div class="td_item_img">';g+='<a href="#">';g+='<img width="90" height="120" alt="" src="'+f+'" bigimg="'+f+'" style="opacity: 1;">';g+="</a>";g+="</div>";g+='<div class="td_item_title clr">';g+="<p>";g+='<a href="#">'+c+"</a>";g+="</p>";g+="<p>";g+='<a href="#">'+h+"</a>";g+="</p>";g+='<p class="padt5">';g+='<span class="color"><em>颜色：</em>'+d+"</span>";g+="<span><em>尺码：</em>"+m+"</span>";g+="</p>";g+="<p>";g+='<span class="noCommodity">售罄</span>';g+="</p>";g+="</div>";g+="</li>";g+='<li class="td_price">';g+="￥"+l;g+="</li>";g+='<li class="td_amount">';g+=k;g+="</li>";g+='<li class="td_sum">';g+='<i class="price_sign">￥</i>';g+='<span class="price_val">'+(l*k)+"</span>";g+="</li>";g+="</ul>";$(g).appendTo($("#alCart_proList_content"));$(g).appendTo($("#alCart_alProList_content"))}});$("#prodNum, .totalNum").html(allTotal);$(".alCart_proList ul.proOver").find("img").css("opacity",".4");if($(".alCart_proList ul:not('.proOver, .prodTitle, .proNone')").length==0){$(".hasprod").hide();$(".alCart_proList dl.proNone").hide();$(".noprod").fadeIn("fast")}}}})}function prodCoupon(a){var b=a.ActiveCount;var c=a.UsedCount;if(a.UsedCount>0){resdata=a.Result;$(resdata).each(function(j){var e=resdata[j].cashticketNo,l=resdata[j].ticketAmount,n=resdata[j].totalUseAmount,h=resdata[j].dateUseEnd,m=resdata[j].ticketDesc,k=resdata[j].orderAmount;var f="1";var g="";var d="";if(k=="0"){f="1";g="现金券";d=l+"元现金券"}else{f="2";g="优惠券";d="满"+k+"元减"+l+"元"}if($("#trNoCashTicket").length>0){$("#trNoCashTicket").remove()}$("<tr class='cur'><td>"+g+"</td><td>"+d+"</td><td>"+h+"</td><td class='explain' tips='"+m+"''><em class='explainTop'>"+m+"</em></td><td> <input type='button' name='couponList' tno='"+e+"' uvalue='"+n+"' ordervalue='"+k+"' ticketvalue='"+l+"' class='btn_operation' value='使用'></td></tr>").appendTo(".alCart_couponList table table#couponsList");$("#cashCount").html(parseInt($("#cashCount").text())+parseInt(a.UsedCount))})}$("#active_tipsbox").find("#txtTipsbox").addClass("succeed").html("您共激活成功<em> "+b+" </em>张优惠券，<br />其中<em> "+c+" </em>张可在本订单使用");$(".alCart_couponList").animate({opacity:0.3},200);setTimeout(function(){$(".toActivate_container").find(".coupon_ajax").hide();$(".toActivate_container").find(".zom").show();$("#active, #active_tipsbox").show();setTimeout(function(){$("#txtTipsbox").removeClass("succeed");$(".toActivate_container").find(".toActivate, .zom").show()},5000);$(".alCart_couponList").animate({opacity:1},200)},1000)};