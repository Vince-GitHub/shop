$(function(){$("#paySubmit_btn").bind("click",function(){$(this).hide();$("#paySubmit").show();var d=true;$(".ccb_choice").find("span").each(function(){var l=$(this);var m;if(l.hasClass("curr")){$(".card_select").each(function(){var n=$(this);m=$(this).find("option:selected").val();if(m!=0){d=true;return false}else{d=false}});$("#HidePayType").val(m)}});if(d==false){$("#error_message").css("visibility","visible").html("请选择对应的明星卡片！");$(this).show();$("#paySubmit").hide();return false}else{$("#error_message").css("visibility","visible").html("")}if($("#buyType").val()!=2){if($("#formOrderConfirm_ConsigneeId").val().length==0){$("#error_message").css("visibility","visible").html("请确认收货地址信息！");$("#paySubmit_btn").show();$("#paySubmit").hide();return false}if($("#isTownId").val()=="0"||$("#isTownId").val()==undefined||$("#isTownId").val()==""){$("#error_message").css("visibility","visible").html("请完善收货地址乡镇信息！");$("#paySubmit_btn").show();$("#paySubmit").hide();getAddr($("#formOrderConfirm_ConsigneeId").val());return false}}if($(".olOrder_express dd input:radio:checked").length<0){$("#error_message").css("visibility","visible").html("请确认送货方式");$("#paySubmit_btn").show();$("#paySubmit").hide();return false}var h=$("#formOrderConfirm_InvoiceTitle").val();if($("#formOrderConfirm_InvoiceType").val()=="2"){h=h==""?"单位":$("#formOrderConfirm_InvoiceTitle").val()}else{h=h==""?"个人":$("#formOrderConfirm_InvoiceTitle").val()}$("#formOrderConfirm_InvoiceTitle").val(h);var g=$("#formOrderConfirm_InvoiceFlag").val();if(g=="1"){if($("#buyType").val()!=2){if($("#formOrderConfirm_fpConsigneeId").val()==""||$("#formOrderConfirm_fpConsigneeId").val()=="0"){if($("input[type='radio'][name='addr']:checked").val()=="0"){$("#error_message").css("visibility","visible").html("暂无发票邮寄地址，请填写！");$("#paySubmit_btn").show();$("#paySubmit").hide();return false}}}else{if($("#formOrderConfirm_fpConsigneeId").val()==""||$("#formOrderConfirm_fpConsigneeId").val()=="0"){$("#error_message").css("visibility","visible").html("请添加发票地址");$("#paySubmit_btn").show();$("#paySubmit").hide();return false}}}else{if($("#formOrderConfirm_InvoiceFlag").val()=="2"){$("#formOrderConfirm_InvoiceType").val("");$("#formOrderConfirm_InvoiceTitle").val("");$("#formOrderConfirm_InvoiceContent").val("")}}if($("#formOrderConfirm_ConsigneeId").val().length==0){$("#formOrderConfirm_ConsigneeId").val("0")}if($("#formOrderConfirm_fpConsigneeId").val().length==0){$("#formOrderConfirm_fpConsigneeId").val("0")}var b="";var e="";var a=new Array();$(".alCart_proList_content ul:not('.fail')").each(function(){var l=$(this).attr("olboxid");a.push(l);e=a.join(",")});e=e.replace(new RegExp(",",("g")),"|");b=e;var j="0";var i="";if($("#formOrderConfirm_CashTicketFlag").length>0&&$("#formOrderConfirm_CashTicketNo").length>0){j=$("#formOrderConfirm_CashTicketFlag").val();i=$("#formOrderConfirm_CashTicketNo").val()}var c="";var k="";if($("#NewShangpinDomainUrl").length>0){c=$("#NewShangpinDomainUrl").val()}if($("#NewShangpinTradeDomainUrl").length>0){k=$("#NewShangpinTradeDomainUrl").val()}if($("#ajaxPost").val()==""){$("#ajaxPost").val("0")}if(b.length==0){$("#error_message").css("visibility","visible").html("无可结算商品");return}if($("#buyType").val().length>0&&$("#buyType").val()!="3"){if($("#HidePayType").val()==""){$("#error_message").css("visibility","visible").html("请选择支付方式");$("#paySubmit").hide();$(this).show();return}$.ajax({type:"GET",url:c+"/Gift/ConfirmGiftOrder",data:{ajaxPost:$("#ajaxPost").val(),ConsigneeId:$("#formOrderConfirm_ConsigneeId").val(),InvoiceAddressId:$("#formOrderConfirm_fpConsigneeId").val(),InvoiceContent:$("#formOrderConfirm_InvoiceContent").val(),InvoiceFlag:$("#formOrderConfirm_InvoiceFlag").val(),InvoiceTitle:$("#formOrderConfirm_InvoiceTitle").val(),InvoiceType:$("#formOrderConfirm_InvoiceType").val(),TimeRequest:$("#formOrderConfirm_TimeRequest").val(),BuyDetailIds:b,cardType:parseInt($("#cardType").val()),buyType:parseInt($("#buyType").val()),buyKey:$("#buyKey").val(),PayType:$("#HidePayType").val()},dataType:"JSONP",jsonp:"callback"}).done(function(l){if(!l.Success){$("#paySubmit_btn").show();$("#paySubmit").hide();if(l.Err=="库存不足"){$("#error_message").css("visibility","visible").html(l.Err)}if(l.Msg=="-2"){$("#error_message").css("visibility","visible").html(l.Err)}if(l.Msg=="-1"){$("#error_message").css("visibility","visible").html(l.Err)}if(l.Msg=="1"){$("#error_message").css("visibility","visible").html(l.Err)}}else{var m=l.Msg.split("|")[0];var n=l.Msg.split("|")[1];switch(m){case"1":window.location.href=$("#ShangpinPayWebUrl").val()+"/payment/paycenter.html?payno="+n;break;case"2":window.location.href=$("#ShangpinPayWebUrl").val()+"/payment/paymsg.html?payno="+n;break;case"index":window.location.href=c+"/"+n;break}}}).fail(function(){})}else{var f;f=$("input:radio[name=giftCard][checked]").val();if($("#HidePayType").val()==""){$("#error_message").css("visibility","visible").html("请选择银行卡");$("#paySubmit").hide();$(this).show();return}$.ajax({type:"POST",url:"/trade/confirmorder?r="+Math.random(),data:{ajaxPost:$("#ajaxPost").val(),ConsigneeId:$("#formOrderConfirm_ConsigneeId").val(),InvoiceAddressId:$("#formOrderConfirm_fpConsigneeId").val(),InvoiceContent:$("#formOrderConfirm_InvoiceContent").val(),InvoiceFlag:$("#formOrderConfirm_InvoiceFlag").val(),InvoiceTitle:$("#formOrderConfirm_InvoiceTitle").val(),InvoiceType:$("#formOrderConfirm_InvoiceType").val(),TimeRequest:$("#formOrderConfirm_TimeRequest").val(),CashTicketFlag:j,CashTicketNo:i,BuysIds:b,PayType:$("#HidePayType").val(),isUseGiftCardPay:f,buyKey:$("#buyKey").val()},dataType:"JSON"}).done(function(l){if(!l.Success){$("#paySubmit_btn").show();$("#paySubmit").hide();if(l.Err=="库存不足"){$("#error_message").css("visibility","visible").html(l.Err)}if(l.Msg=="-2"){$("#error_message").css("visibility","visible").html(l.Err)}if(l.Msg=="-1"){showCartList(parseInt($("#buyType").val()),$("#buyKey").val());$("#error_message").css("visibility","visible").html("该订单中部分商品过期或已售馨！")}if(l.Msg=="1"){showCartList(parseInt($("#buyType").val()),$("#buyKey").val());$("#error_message").css("visibility","visible").html("该订单中部分商品过期或已售馨！")}if(l.Msg=="2"){showCartList(parseInt($("#buyType").val()),$("#buyKey").val());$("#error_message").css("visibility","visible").html("该订单中部分商品过期或已售馨！")}}else{var m=l.Msg.split("|")[0];var o=l.Msg.split("|")[1];var n=$("#gifts_price").html();switch(m){case"1":if(n>0){window.location.href=$("#ShangpinPayWebUrl").val()+"/payment/paycenter.html?payno="+o}else{var p=$("#HidePayType").val();var q=0;if($("#HidePayType").val()!=""){var r=p.split("_")[0];q=parseInt(r)}if(q==4){window.location.href=$("#ShangpinPayWebUrl").val()+"/payment/paymsg.html?payno="+o}else{window.location.href=$("#ShangpinPayWebUrl").val()+"/payment/paycenter.html?payno="+o}}break;case"2":window.location.href=$("#ShangpinPayWebUrl").val()+"/payment/paymsg.html?payno="+o;break;case"index":window.location.href="/"+o;break}}}).fail(function(){})}$(".alCart_proList dl.proOver").find("img").css("opacity",".4")})});function showCartList(b,a){$.ajax({type:"GET",url:"/trade/GetNewCartList?buyType="+parseInt($("#buyType").val())+"&buyKey="+$("#buyKey").val()+"&r="+Math.random(),async:false,complete:function(c){$("#divtest").html(c.responseText)},dataType:"html"})}function checkCartCount(a,b,c){var d="";var e="";if(typeof(a)!="undefined"){d=a}if(typeof(b)!="undefined"){e=b}$.ajax({type:"Get",url:"/trade/GetCartCount?key="+d+"&type="+e+"&isOutside="+c+"&r="+Math.random(),async:false,success:function(f){if(f.Count==0){if(d==""||d==null){location.href="/trade/cart?r="+Math.random()}else{if(e=="3"){location.href=$("#NewShangpinDomainUrl").val()}else{location.href=$("#NewShangpinDomainUrl").val()+"/giftcard/"}}}},dataType:"JSON"})};